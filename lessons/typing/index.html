<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Typing Skills — KidCoder</title>
  <link rel="stylesheet" href="../../assets/style.css" />
  <style>
    /* light, local styles that shouldn't fight your theme */
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .toolbar .group { display:flex; gap:6px; align-items:center; }
    .toolbar .pill { padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none; border:1px solid var(--border, #3333); }
    .toolbar .pill.active { outline:2px solid currentColor; }
    .typing-stage { 
      min-height: 170px; line-height: 2.0; font-size: 1.25rem;
      padding:16px; border-radius:12px; border:1px solid var(--border, #3333);
      position:relative; overflow:hidden; 
    }
    .words { color: var(--text, inherit); }
    .char { opacity:.6; }
    .char.correct { color: var(--text, inherit); opacity:1; }
    .char.incorrect { color: #e16363; opacity:1; text-decoration: underline; }
    .caret { position: absolute; width:2px; background: currentColor; height:1.5em; animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    .stats { display:flex; gap:18px; flex-wrap:wrap; margin-top:10px; }
    .stat { padding:8px 12px; border-radius:8px; border:1px solid var(--border, #3333); }
    .muted-small { opacity:.7; font-size:.9rem; }
    .hidden-input { position:absolute; opacity:0; pointer-events:none; }
    .footer-hint { opacity:.6; font-size:.9rem; display:flex; justify-content:space-between; }
  </style>
</head>
<body>
  <header class="header">
    <div class="nav container">
      <div class="brand"><div class="logo"></div> <span id="greeting"></span></div>
      <nav><a class="button secondary" href="../../index.html">Home</a></nav>
    </div>
  </header>

  <main class="container">
    <section class="card" style="padding:18px;">
      <h2 style="margin-bottom:6px;">Typing Practice</h2>
      <p class="muted">Choose a mode, then start typing—no need to click the box.</p>

      <!-- toolbar -->
      <div class="toolbar" style="margin:12px 0 14px;">
        <div class="group">
          <span class="muted-small">mode</span>
          <button class="pill active" data-mode="time">time</button>
          <button class="pill" data-mode="words">words</button>
        </div>
        <div class="group" id="timeGroup">
          <span class="muted-small">seconds</span>
          <button class="pill" data-time="15">15</button>
          <button class="pill active" data-time="30">30</button>
          <button class="pill" data-time="60">60</button>
          <button class="pill" data-time="120">120</button>
        </div>
        <div class="group" id="wordsGroup" style="display:none;">
          <span class="muted-small">words</span>
          <button class="pill" data-words="10">10</button>
          <button class="pill active" data-words="25">25</button>
          <button class="pill" data-words="50">50</button>
        </div>
        <div class="group">
          <span class="muted-small">options</span>
          <button class="pill" id="togglePunct">punctuation</button>
          <button class="pill" id="toggleNums">numbers</button>
        </div>
        <div class="group" style="margin-left:auto;">
          <button id="restartBtn" class="button secondary">Restart</button>
        </div>
      </div>

      <!-- typing stage -->
      <div class="typing-stage" id="stage" tabindex="-1">
        <input id="hiddenInput" class="hidden-input" aria-hidden="true" />
        <div id="words" class="words"></div>
        <div id="caret" class="caret" style="top:16px; left:16px;"></div>
      </div>

      <!-- stats -->
      <div class="stats" style="margin-top:14px;">
        <div class="stat"><strong id="wpm">0</strong> WPM</div>
        <div class="stat"><strong id="acc">100%</strong> accuracy</div>
        <div class="stat"><strong id="timer">30</strong> sec</div>
        <div class="stat"><strong id="progress">0</strong>/<span id="total">0</span> chars</div>
      </div>

      <div class="footer-hint" style="margin-top:10px;">
        <span class="muted-small">Tip: press <kbd>Tab</kbd> + <kbd>Enter</kbd> to restart</span>
        <span class="muted-small">Focus lost? Click anywhere in the box.</span>
      </div>
    </section>
  </main>

  <footer class="footer">© KidCoder • Typing</footer>

  <script>
    // ======== Word sources ========
    const BASE_WORDS = ("develop between may day general because last no see then program this think problem lead thing might people make off early child great work all while still it if other order set lead change go use world small large often never always build learn code input output logic type quick brown fox jumps over the lazy dog time speed focus calm practice improve create test simple clean design data school study energy friend light dark space open close begin end")
      .split(" ");
    const PUNCT = [",", ".", "?", "!", ";", ":"];
    const NUMS  = ["0","1","2","3","4","5","6","7","8","9"];

    // ======== State ========
    const state = {
      mode: "time",        // "time" | "words"
      seconds: 30,
      wordsTarget: 25,
      allowPunct: false,
      allowNums: false,

      started: false,
      finished: false,
      startTime: 0,
      elapsed: 0,
      timerId: null,

      targetText: "",
      cursor: 0,
      correct: 0,
      typed: 0
    };

    // ======== Elements ========
    const stage = document.getElementById("stage");
    const hiddenInput = document.getElementById("hiddenInput");
    const wordsEl = document.getElementById("words");
    const caretEl = document.getElementById("caret");

    const wpmEl = document.getElementById("wpm");
    const accEl = document.getElementById("acc");
    const timerEl = document.getElementById("timer");
    const progEl = document.getElementById("progress");
    const totalEl = document.getElementById("total");

    // toolbar
    const timeGroup = document.getElementById("timeGroup");
    const wordsGroup = document.getElementById("wordsGroup");
    const restartBtn = document.getElementById("restartBtn");
    const togglePunct = document.getElementById("togglePunct");
    const toggleNums  = document.getElementById("toggleNums");

    // ======== Utilities ========
    function sampleWords(n) {
      const pool = BASE_WORDS.slice();
      if (state.allowNums) pool.push(...NUMS);
      let out = [];
      for (let i = 0; i < n; i++) {
        const w = pool[Math.floor(Math.random() * pool.length)];
        let word = w;
        if (state.allowPunct && Math.random() < 0.18) {
          const p = PUNCT[Math.floor(Math.random() * PUNCT.length)];
          word = Math.random() < 0.5 ? (word + p) : (p + word);
        }
        out.push(word);
      }
      return out.join(" ");
    }

    function genTarget() {
      if (state.mode === "time") {
        // long stream, user types until time ends
        state.targetText = sampleWords(220); // plenty for 120s
      } else {
        state.targetText = sampleWords(state.wordsTarget);
      }
      renderTarget();
      totalEl.textContent = state.targetText.length;
      moveCaret();
    }

    function renderTarget() {
      const frag = document.createDocumentFragment();
      for (let i = 0; i < state.targetText.length; i++) {
        const span = document.createElement("span");
        span.className = "char";
        span.textContent = state.targetText[i];
        frag.appendChild(span);
      }
      wordsEl.innerHTML = "";
      wordsEl.appendChild(frag);
    }

    function updateMetrics() {
      const minutes = Math.max(state.elapsed, (performance.now() - state.startTime)/1000) / 60;
      const grossWPM = Math.floor((state.correct / 5) / Math.max(minutes, 1/60));
      const acc = state.typed ? Math.round((state.correct / state.typed) * 100) : 100;
      wpmEl.textContent = isFinite(grossWPM) ? grossWPM : 0;
      accEl.textContent = acc + "%";
      progEl.textContent = state.cursor;
    }

    function moveCaret() {
      // position caret roughly at current character
      const chars = wordsEl.children;
      let targetNode = chars[state.cursor];
      if (!targetNode) {
        // end of text -> place after last char
        targetNode = chars[chars.length - 1];
        if (!targetNode) return;
        const rect = targetNode.getBoundingClientRect();
        caretEl.style.top = (targetNode.offsetTop) + "px";
        caretEl.style.left = (targetNode.offsetLeft + targetNode.offsetWidth + 2) + "px";
        return;
      }
      caretEl.style.top = (targetNode.offsetTop) + "px";
      caretEl.style.left = (targetNode.offsetLeft) + "px";
    }

    function startIfNeeded() {
      if (state.started) return;
      state.started = true;
      state.startTime = performance.now();
      if (state.mode === "time") {
        timerEl.textContent = state.seconds;
        state.timerId = setInterval(() => {
          const elapsed = Math.floor((performance.now() - state.startTime)/1000);
          state.elapsed = elapsed;
          const remain = Math.max(state.seconds - elapsed, 0);
          timerEl.textContent = remain;
          updateMetrics();
          if (remain <= 0) finish();
        }, 100);
      }
    }

    function finish() {
      if (state.finished) return;
      state.finished = true;
      clearInterval(state.timerId);
      state.elapsed = Math.max(state.elapsed, (performance.now() - state.startTime)/1000);
      updateMetrics();
      hiddenInput.blur();
    }

    function reset() {
      clearInterval(state.timerId);
      state.started = false;
      state.finished = false;
      state.startTime = 0;
      state.elapsed = 0;
      state.cursor = 0;
      state.correct = 0;
      state.typed = 0;
      timerEl.textContent = state.mode === "time" ? state.seconds : "—";
      genTarget();
      updateMetrics();
      stage.focus();
      hiddenInput.focus();
    }

    // ======== Typing logic ========
    function handleKey(e) {
      if (state.finished) return;
      startIfNeeded();

      if (e.key === "Tab") return; // allow our restart combo
      if (e.key === "Escape") { e.preventDefault(); reset(); return; }

      const expected = state.targetText[state.cursor];

      if (e.key.length === 1) {
        e.preventDefault();
        state.typed++;

        const node = wordsEl.children[state.cursor];
        if (!node) return;

        if (e.key === expected) {
          node.classList.add("correct");
          state.correct++;
          state.cursor++;
        } else {
          node.classList.add("incorrect");
          state.cursor++; // advanced even if wrong, monkeytype-style
        }

        updateMetrics();
        moveCaret();

        if (state.mode === "words" && state.cursor >= state.targetText.length) {
          state.elapsed = (performance.now() - state.startTime)/1000;
          finish();
        }
      } else if (e.key === "Backspace") {
        e.preventDefault();
        if (state.cursor > 0) {
          const prev = wordsEl.children[state.cursor - 1];
          if (prev) prev.classList.remove("correct","incorrect");
          // adjust counters
          const wasCorrect = prev && prev.classList.contains("correct");
          // can't check after removing classes; compute by comparing:
          const priorChar = state.targetText[state.cursor - 1];
          // if previous keystroke was a character, decrement typed (best effort)
          state.typed = Math.max(0, state.typed - 1);
          if (priorChar && wasCorrect) state.correct = Math.max(0, state.correct - 1);
          state.cursor--;
          updateMetrics();
          moveCaret();
        }
      } else if (e.key === "Enter") {
        // ignore during run (monkeytype ignores newlines)
        e.preventDefault();
      }
    }

    // ======== Toolbar wiring ========
    document.querySelectorAll('[data-mode]').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('[data-mode]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.mode = btn.dataset.mode;
        timeGroup.style.display  = state.mode === "time" ? "" : "none";
        wordsGroup.style.display = state.mode === "words" ? "" : "none";
        reset();
      });
    });

    timeGroup.querySelectorAll('[data-time]').forEach(btn => {
      btn.addEventListener('click', () => {
        timeGroup.querySelectorAll('[data-time]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.seconds = parseInt(btn.dataset.time, 10);
        reset();
      });
    });

    wordsGroup.querySelectorAll('[data-words]').forEach(btn => {
      btn.addEventListener('click', () => {
        wordsGroup.querySelectorAll('[data-words]').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.wordsTarget = parseInt(btn.dataset.words, 10);
        reset();
      });
    });

    togglePunct.addEventListener('click', () => {
      togglePunct.classList.toggle('active');
      state.allowPunct = !state.allowPunct;
      reset();
    });
    toggleNums.addEventListener('click', () => {
      toggleNums.classList.toggle('active');
      state.allowNums = !state.allowNums;
      reset();
    });

    restartBtn.addEventListener('click', reset);

    // restart with Tab + Enter
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        window.__tabDown = true;
      } else if (e.key === 'Enter' && window.__tabDown) {
        e.preventDefault();
        reset();
      }
    });
    window.addEventListener('keyup', (e) => {
      if (e.key === 'Tab') window.__tabDown = false;
    });

    // focus handling
    stage.addEventListener('click', () => hiddenInput.focus());
    window.addEventListener('resize', moveCaret);
    hiddenInput.addEventListener('keydown', handleKey);

    // ======== Init ========
    genTarget();
    updateMetrics();
    // set initial focus so user can just start typing:
    setTimeout(() => hiddenInput.focus(), 0);
  </script>
    <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { firebaseConfig } from "../../assets/firebase-config.js";  // ✅ two levels up
  
    // Reuse the same Firebase app if it already exists
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
  
    const el = document.getElementById("greeting");
    onAuthStateChanged(auth, (user) => {
      if (!el) return;
      if (!user) { el.textContent = ""; return; }
  
      const base = user.displayName || (user.email || "").split("@")[0] || "there";
      const first = base.trim().split(/\s+/)[0];
      el.textContent = `Hi ${first}!`;
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LogicPoint • Firebase Auth Demo</title>
  <link rel="stylesheet" href="assets/style.css" />
  <style>
    /* minimal safe defaults if your style.css is empty */
    :root { color-scheme: light dark; }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    header { display:flex; align-items:center; gap:12px; padding:14px 18px; border-bottom:1px solid #0001; }
    .brand { font-weight:700; }
    .spacer { flex:1 }
    .pill { padding:8px 14px; border-radius:999px; border:1px solid #0002; background:#00000008; cursor:pointer; }
    .pill[disabled]{ opacity:.6; cursor:not-allowed; }
    main { max-width:900px; margin:24px auto; padding:0 18px; }
    .card { border:1px solid #0001; border-radius:16px; padding:18px; }
    .muted { opacity:.7; font-size:.95rem; }
    #authStatus { font-variant-numeric: tabular-nums; }
  </style>
</head>
<body>

  <header>
    <div class="brand" id="brandName">Guest</div>
    <div id="authStatus" class="muted">auth: …</div>
    <div class="spacer"></div>
    <button id="loginBtn"  class="pill">Sign in with Google</button>
    <button id="logoutBtn" class="pill" style="display:none">Sign out</button>
  </header>

  <main>
    <div class="card">
      <h2>Welcome</h2>
      <p class="muted">
        This page demonstrates Firebase Auth (Google). Your real config is loaded from
        <code>assets/firebase-config.js</code>, which is <em>ignored by git</em>.
      </p>
      <pre id="debug" class="muted" style="white-space:pre-wrap"></pre>
    </div>
  </main>

  <!-- Firebase + app logic -->
  <script type="module">
    // 1) import your **local** config (keep real keys only in assets/firebase-config.js)
    import { firebaseConfig } from "./assets/firebase-config.js";

    // 2) import Firebase SDKs (v11)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut,
      onAuthStateChanged, setPersistence,
      browserLocalPersistence, browserSessionPersistence
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // 3) init
    const app  = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // 4) dom refs
    const statusEl = document.getElementById("authStatus");
    const brandEl  = document.getElementById("brandName");
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn= document.getElementById("logoutBtn");
    const debugEl  = document.getElementById("debug");

    const setStatus = (s) => { statusEl.textContent = `auth: ${s}`; };
    const show = (el, on) => { el.style.display = on ? "" : "none"; };

    // 5) tiny helpers
    async function upsertUser(u){
      // keep user profile in /users/{uid}
      try {
        await setDoc(doc(db, "users", u.uid), {
          uid: u.uid,
          displayName: u.displayName ?? "",
          email: u.email ?? "",
          photoURL: u.photoURL ?? "",
          updatedAt: serverTimestamp()
        }, { merge: true });
      } catch (e) {
        console.warn("upsertUser skipped:", e.message);
      }
    }
    async function preferredName(u){
      try {
        const snap = await getDoc(doc(db, "users", u.uid));
        if (snap.exists() && snap.data().username) return snap.data().username;
      } catch {}
      const fallback = u?.displayName || u?.email || "User";
      return fallback.split(" ")[0];
    }
    function renderSignedOut(){
      brandEl.textContent = "Guest";
      setStatus("signed out");
      show(loginBtn, true);
      show(logoutBtn, false);
      debugEl.textContent = "";
    }
    async function renderSignedIn(u){
      brandEl.textContent = await preferredName(u);
      setStatus("signed in");
      show(loginBtn, false);
      show(logoutBtn, true);
      debugEl.textContent = JSON.stringify({
        uid: u.uid,
        displayName: u.displayName,
        email: u.email
      }, null, 2);
    }

    // 6) button wiring
    loginBtn.addEventListener("click", async () => {
      try {
        loginBtn.disabled = true;
        const res = await signInWithPopup(auth, provider);
        await upsertUser(res.user);
        await renderSignedIn(res.user);
      } catch (e) {
        alert(e.message);
        console.error(e);
      } finally {
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      try {
        logoutBtn.disabled = true;
        await signOut(auth);
        renderSignedOut();
      } catch (e) {
        alert(e.message);
        console.error(e);
      } finally {
        logoutBtn.disabled = false;
      }
    });

    // 7) persistence + one auth observer
    (async () => {
      try {
        // prefer durable local; fall back to session if blocked
        await setPersistence(auth, browserLocalPersistence);
      } catch {
        await setPersistence(auth, browserSessionPersistence);
      }
      onAuthStateChanged(auth, async (user) => {
        if (user) await renderSignedIn(user);
        else renderSignedOut();
      });
    })();
  </script>
</body>
</html>
